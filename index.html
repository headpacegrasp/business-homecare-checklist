<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comfort Keepers Onboarding Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light blue-gray background */
        }
        /* Custom styles for smoother collapse animation */
        .collapse-content {
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            max-height: 0;
            overflow: hidden;
        }
        .collapse-open {
            max-height: 10000px; 
            padding-bottom: 1rem; /* Add padding when open */
        }
        .rotated-icon {
            transform: rotate(90deg);
        }
        /* Style for the actual cost input for alignment */
        .cost-input {
            appearance: none;
            -moz-appearance: textfield;
        }
        .cost-input::-webkit-inner-spin-button, 
        .cost-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10">

    <div id="app" class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">Onboarding Tracker</h1>
            <p class="text-gray-500 mt-2 text-xl font-medium">Comfort Keepers Franchise - Annapolis, MD</p>
            <div class="mt-4 flex justify-center items-center">
                <span id="user-id-display" class="text-xs font-mono text-gray-400 p-1 bg-gray-100 rounded">User ID: Loading...</span>
            </div>
        </header>
        
        <!-- Loading Indicator -->
        <div id="loading-spinner" class="text-center p-12 text-indigo-500">
            <svg class="animate-spin h-10 w-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-sm font-medium">Loading checklist data and saved status...</p>
        </div>

        <!-- Summary Cards -->
        <div id="summary-container" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12 hidden">
            
            <!-- Progress Card -->
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-600">
                <p class="text-sm font-medium text-indigo-600 uppercase tracking-wider">Progress</p>
                <div class="flex justify-between items-end mt-1">
                    <div class="text-3xl font-extrabold text-gray-900">
                        <span id="completed-count">0</span> / <span id="total-count">0</span>
                    </div>
                    <p id="progress-percent" class="text-2xl font-bold text-gray-500">0%</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full shadow-md" style="width: 0%"></div>
                </div>
            </div>

            <!-- Estimated Cost Card -->
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-gray-400">
                <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Estimated Budget</p>
                <div id="est-cost-display" class="text-3xl font-extrabold text-gray-900 mt-1">$0.00</div>
                <p class="text-xs text-gray-400 mt-1">Total projected cost.</p>
            </div>
            
            <!-- Actual Cost Card -->
            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-green-600">
                <p class="text-sm font-medium text-green-600 uppercase tracking-wider">Actual Spend</p>
                <div id="actual-cost-display" class="text-3xl font-extrabold text-green-700 mt-1">$0.00</div>
                <p class="text-xs text-gray-400 mt-1">Based on current entries.</p>
            </div>

            <!-- Variance Card -->
            <div id="variance-card" class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-yellow-600">
                <p class="text-sm font-medium text-yellow-600 uppercase tracking-wider">Budget Variance</p>
                <div id="variance-display" class="text-3xl font-extrabold text-gray-900 mt-1">$0.00</div>
                <p id="variance-status" class="text-xs text-gray-400 mt-1">On track.</p>
            </div>
        </div>

        <!-- Checklist Container -->
        <div id="checklist-container" class="hidden">
            <!-- Checklist items will be injected here -->
        </div>

        <!-- Custom Modal for Messages (Error/Success) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <button onclick="closeModal()" class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition">Understood</button>
            </div>
        </div>

    </div>

    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc,
            setDoc,
            query, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP & FIREBASE INITIALIZATION ---

        setLogLevel('Debug');
        // IMPORTANT: The environment variables below are provided by the Canvas framework.
        // If deploying this publicly, replace these with your actual Firebase configuration.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Check if firebaseConfig is valid before initializing
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing. Data persistence will be disabled.");
        }
        
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;
        
        let userId = null;
        let checklistState = {}; // Stores the completion status and actual cost from Firestore
        
        // --- UI ELEMENTS ---
        const checklistContainer = document.getElementById('checklist-container');
        const summaryContainer = document.getElementById('summary-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userIdDisplay = document.getElementById('user-id-display');
        const completedCountEl = document.getElementById('completed-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBarEl = document.getElementById('progress-bar');
        const progressPercentEl = document.getElementById('progress-percent');
        const estCostDisplay = document.getElementById('est-cost-display');
        const actualCostDisplay = document.getElementById('actual-cost-display');
        const varianceDisplay = document.getElementById('variance-display');
        const varianceCardEl = document.getElementById('variance-card');
        const varianceStatusEl = document.getElementById('variance-status');


        // --- CHECKLIST DATA (Copied from previous version) ---
        const initialChecklistData = [
            { phase: "Pre-Opening Phase", sections: [
                { title: "Legal & Business Formation", items: [
                    { name: "Register Business Entity", summary: "Establish business as legal entity with state of Maryland.", timeline: "30-45 days before opening", cost_est: 200, id: "register_entity" },
                    { name: "Obtain Federal EIN", summary: "Required for hiring, bank accounts, and taxes.", timeline: "Immediately after entity formation", cost_est: 0, id: "obtain_ein" },
                    { name: "Apply for Anne Arundel County Business License", summary: "Local operating permit required to legally conduct business.", timeline: "2-4 weeks processing", cost_est: 100, id: "county_license" },
                    { name: "Register with Maryland Board of Labor, Industry and Licensing", summary: "State-level registration for employers (unemployment, workers' compensation).", timeline: "Before hiring first employee", cost_est: 0, id: "labor_licensing" },
                    { name: "Complete Home Care Agency Registration", summary: "Maryland specific licensing for home care agencies.", timeline: "60-90 days processing", cost_est: 350, id: "agency_reg" },
                    { name: "Obtain Local Health Department Clearances", summary: "Ensures compliance with public health standards.", timeline: "2-4 weeks", cost_est: 50, id: "health_clearances" },
                    { name: "General Liability Insurance", summary: "Protects business from claims of bodily injury, property damage.", cost_est: 2250, id: "gen_liab_ins" },
                    { name: "Professional Liability Insurance (E&O)", summary: "Protects against claims of negligence or mistakes in care.", cost_est: 3000, id: "prof_liab_ins" },
                    { name: "Workers' Compensation Insurance", summary: "Mandatory coverage in Maryland for employee injuries.", cost_est: 0, id: "workers_comp_ins" }, 
                    { name: "Commercial Auto Insurance", summary: "Covers vehicles used for business purposes.", cost_est: 1850, id: "auto_ins" },
                    { name: "Employment Practices Liability Insurance (EPLI)", summary: "Protects against claims like wrongful termination, harassment.", cost_est: 1150, id: "epli_ins" },
                    { name: "Cyber Liability Insurance", summary: "Covers data breaches and loss of client personal information.", cost_est: 750, id: "cyber_ins" }
                ]},
                { title: "Franchise Agreement & Training", items: [
                    { name: "Sign Franchise Disclosure Document (FDD)", summary: "Legal disclosure document. Must receive 14 days before signing agreement.", timeline: "Allow 2-3 weeks for review", cost_est: 1000, id: "sign_fdd" }, 
                    { name: "Execute Franchise Agreement", summary: "Binding contract defining rights, responsibilities, and fees.", timeline: "After FDD review period", cost_est: 59950, id: "exec_agreement" }, 
                    { name: "Complete Item 19 Financial Performance Review", summary: "Analyze financial performance data from existing franchises.", timeline: "During FDD review period", cost_est: 0, id: "item19_review" },
                    { name: "Review Territory Rights and Exclusivity Terms", summary: "Understand geographic boundaries and restrictions.", timeline: "Before signing franchise agreement", cost_est: 0, id: "territory_review" },
                    { name: "Complete Corporate Training at Headquarters", summary: "Intensive training program (1-2 weeks).", timeline: "Within 30 days of signing", cost_est: 2250, id: "hq_training" }, 
                    { name: "Operations Management Training", summary: "Learn scheduling, quality assurance, and administrative procedures.", timeline: "Part of initial training", cost_est: 0, id: "ops_training" },
                    { name: "Sales and Marketing Fundamentals", summary: "Training on selling home care, referral networks, and lead conversion.", timeline: "Part of initial training", cost_est: 0, id: "sales_marketing_training" },
                    { name: "Care Coordinator Certification", summary: "Specialized training for client assessments and care plans.", timeline: "Part of initial training", cost_est: 0, id: "coord_cert" },
                    { name: "Technology Platform Training", summary: "Comprehensive training on franchise software systems (CRM, scheduling, billing).", timeline: "Part of initial training", cost_est: 0, id: "tech_platform_training" },
                    { name: "Compliance and Regulatory Requirements Training", summary: "Training on HIPAA, employment laws, and documentation.", timeline: "Part of initial training", cost_est: 0, id: "compliance_training" }
                ]},
                { title: "Office Setup", items: [
                    { name: "Secure Office Space in Annapolis", summary: "Lease 800-1,200 sq ft office in professional building.", timeline: "Secure 60 days before opening", cost_est: 3125, id: "secure_office" }, 
                    { name: "Verify ADA Compliance", summary: "Ensure office meets accessibility requirements.", timeline: "During site selection", cost_est: 0, id: "verify_ada" },
                    { name: "Ensure Professional Appearance for Client Meetings", summary: "Select location with professional ambiance and private consultation space.", timeline: "During site selection", cost_est: 0, id: "professional_appearance" },
                    { name: "Install Furniture and Fixtures", summary: "Desks, chairs, filing cabinets, reception seating.", timeline: "2-3 weeks before opening", cost_est: 6500, id: "install_furniture" },
                    { name: "Install Signage (Interior and Exterior)", summary: "Branded signage meeting Comfort Keepers standards.", timeline: "3-4 weeks before opening", cost_est: 3000, id: "install_signage" },
                    { name: "Set Up Phone System", summary: "Professional VoIP system with main line (410) 224-3849.", timeline: "2 weeks before opening", cost_est: 100, id: "setup_phone" }, 
                    { name: "Install Computer Equipment and Software", summary: "Computers/laptops, printers, monitors, software licenses.", timeline: "2 weeks before opening", cost_est: 4000, id: "install_computer" },
                    { name: "Stock Office Supplies and Materials", summary: "Paper, pens, folders, client forms, first aid supplies.", timeline: "1 week before opening", cost_est: 750, id: "stock_supplies" },
                    { name: "Install Security System", summary: "Alarm system for office and confidential files.", timeline: "Before moving in equipment", cost_est: 750, id: "install_security" }
                ]},
                { title: "Technology & Systems", items: [
                    { name: "Implement ClearCare Operations Platform", summary: "Comprehensive software for scheduling, billing, and records.", timeline: "2-3 weeks before opening", cost_est: 300, id: "clearcare_platform" }, 
                    { name: "Set Up Login Credentials for All Users", summary: "Create secure accounts with appropriate permissions.", timeline: "During software implementation", cost_est: 0, id: "setup_logins" },
                    { name: "Complete Data Migration (if applicable)", summary: "Migrate existing client/caregiver data to new platform.", timeline: "Before go-live date", cost_est: 1000, id: "data_migration" },
                    { name: "Train Staff on Platform Usage", summary: "Training on scheduling, documentation, reports, and billing.", timeline: "Week before opening and first 2 weeks", cost_est: 0, id: "platform_training" },
                    { name: "Set Up Business Phone Line (410) 224-3849", summary: "Dedicated business line for professional appearance and call tracking.", timeline: "2 weeks before opening", cost_est: 75, id: "setup_business_phone_line" }, 
                    { name: "Set Up Email Using Comfort Keepers Domain", summary: "Professional email addresses (yourname@comfortkeepers.com format).", timeline: "2 weeks before opening", cost_est: 0, id: "setup_email" },
                    { name: "Configure Website Subdomain", summary: "Customize local website (annapolis.comfortkeepers.com) template.", timeline: "3-4 weeks before opening", cost_est: 0, id: "configure_website" }, 
                    { name: "Set Up Social Media Business Accounts", summary: "Facebook, Instagram, LinkedIn pages for local presence.", timeline: "2-3 weeks before opening", cost_est: 0, id: "setup_social" },
                    { name: "Order Business Cards (Owner, Staff, Caregivers)", summary: "Professional cards for networking and referrals.", timeline: "3 weeks before opening", cost_est: 150, id: "order_cards" },
                    { name: "Order Brochures and Service Guides", summary: "Marketing materials explaining services and pricing.", timeline: "3 weeks before opening", cost_est: 400, id: "order_brochures" },
                    { name: "Prepare Client Welcome Packets", summary: "Assemble packets with service agreement, handbook, etc.", timeline: "Week before opening", cost_est: 150, id: "prepare_welcome_packets" },
                    { name: "Create Caregiver Recruitment Materials", summary: "Flyers, job descriptions, and marketing materials for recruitment.", timeline: "3-4 weeks before opening", cost_est: 250, id: "create_recruitment_materials" },
                    { name: "Order Branded Apparel and Name Tags", summary: "Polo shirts/scrubs with logo for professional image.", timeline: "3-4 weeks before opening", cost_est: 750, id: "order_apparel" }
                ]},
                { title: "Staffing & Recruitment: Key Personnel Hiring", items: [
                    { name: "Establish Owner/Operator Role", summary: "Define role: strategic planning, sales, financial management (22+ hrs/wk).", timeline: "Immediately upon franchise signing", cost_est: 0, id: "establish_owner_role" },
                    { name: "Complete Owner HR Compliance Training", summary: "Training on employment laws, hiring practices, wage laws.", timeline: "Before hiring first employee", cost_est: 350, id: "owner_hr_training" },
                    { name: "Complete Owner Background Check and Clearances", summary: "Required background checks and health clearances for owner/manager.", timeline: "During licensing process", cost_est: 75, id: "owner_bg_check" },
                    { name: "Recruit Office Staff Position", summary: "First hire: handles reception, scheduling, billing, admin.", timeline: "Hire 2-3 weeks before opening", cost_est: 0, id: "recruit_office_staff" },
                    { name: "Interview and Hire Office Staff", summary: "Structured interview process, skills testing.", timeline: "3-4 weeks before opening", cost_est: 0, id: "hire_office_staff" },
                    { name: "Complete Office Staff Onboarding", summary: "Paperwork, benefits, system training, shadowing.", timeline: "1-2 weeks before opening", cost_est: 0, id: "onboard_office_staff" },
                    { name: "Set Up Office Staff Employee Files", summary: "Confidential personnel file (I-9, W-4, background check, etc.).", timeline: "During onboarding", cost_est: 0, id: "setup_staff_files" },
                    { name: "Hire Experienced Care Coordinator", summary: "Conducts assessments, develops care plans, client contact.", timeline: "Hire 2 weeks before opening", cost_est: 0, id: "hire_care_coordinator" },
                    { name: "Complete Care Coordinator Certification", summary: "Specialized training in assessment techniques and protocols.", timeline: "Within first 30 days of employment", cost_est: 0, id: "coord_cert_emp" },
                    { name: "Train Care Coordinator on Assessment Protocols", summary: "Detailed training on in-home assessments and documentation.", timeline: "First 2 weeks of employment", cost_est: 0, id: "coord_protocol_train" },
                    { name: "Shadow Existing Coordinator (if available)", summary: "Hands-on learning by accompanying experienced coordinator.", timeline: "First 1-2 weeks", cost_est: 0, id: "coord_shadowing" }
                ]},
                { title: "Staffing & Recruitment: Caregiver Recruitment & Onboarding", items: [
                    { name: "Post Jobs on Indeed", summary: "Primary job board for recruitment (sponsored posts).", timeline: "4-6 weeks before opening", cost_est: 225, id: "post_indeed" }, 
                    { name: "Post Jobs on Care.com", summary: "Care industry-specific job board for qualified candidates.", timeline: "4-6 weeks before opening", cost_est: 300, id: "post_carecom" }, 
                    { name: "Post on Local Job Platforms", summary: "Community colleges, local employment websites.", timeline: "4-6 weeks before opening", cost_est: 50, id: "post_local_jobs" },
                    { name: "Partner with Community Organizations", summary: "Build relationships for candidate referrals (churches, senior centers).", timeline: "Ongoing, start 4-6 weeks before opening", cost_est: 0, id: "partner_community" },
                    { name: "Implement Caregiver Referral Program", summary: "Incentivize current caregivers (Typical bonus $250-500).", timeline: "Launch at opening", cost_est: 0, id: "referral_program" }, 
                    { name: "Attend Job Fairs and Community Events", summary: "Direct recruitment and immediate screening.", timeline: "Ongoing starting 4 weeks before opening", cost_est: 125, id: "attend_job_fairs" },
                    { name: "Review Applications and Initial Screening", summary: "Systematic review and phone screening.", timeline: "Ongoing as applications received", cost_est: 0, id: "screen_applicants" },
                    { name: "Conduct In-Person Interviews", summary: "Assess personality, skills, and cultural fit.", timeline: "Ongoing, plan 2-3 weeks for hiring process", cost_est: 0, id: "conduct_interviews" },
                    { name: "Conduct Criminal Background Checks", summary: "Mandatory comprehensive check (county, state, national).", timeline: "After conditional offer", cost_est: 38, id: "bg_checks" }, 
                    { name: "Check Driving Records (MVR)", summary: "Check for caregivers who will drive for work.", timeline: "With background check", cost_est: 15, id: "mvr_check" }, 
                    { name: "Check Professional References", summary: "Verify employment history, reliability, and character.", timeline: "After interview, before offer", cost_est: 0, id: "check_references" },
                    { name: "Complete Drug Screening", summary: "Pre-employment drug test for impaired judgment prevention.", timeline: "After conditional offer", cost_est: 40, id: "drug_screening" }, 
                    { name: "Conduct TB Testing", summary: "Tuberculosis testing required in most states.", timeline: "Before first client assignment", cost_est: 38, id: "tb_testing" }, 
                    { name: "Obtain Health Clearances", summary: "General health screening/physical exam.", timeline: "Before first client assignment", cost_est: 0, id: "health_clearances_cg" }, 
                    { name: "Complete New Hire Paperwork", summary: "I-9, W-4, direct deposit, etc.", timeline: "First day of employment", cost_est: 0, id: "new_hire_paperwork" },
                    { name: "Review and Sign Employee Handbook", summary: "Outlines policies, procedures, and rules (signed acknowledgment).", timeline: "Orientation day", cost_est: 0, id: "sign_handbook" },
                    { name: "Complete Orientation Training", summary: "16-40 hours covering policies, safety, infection control, basic skills.", timeline: "Before first client assignment", cost_est: 0, id: "cg_orientation_training" }, 
                    { name: "Dementia Care Training Certification", summary: "Specialized training for Alzheimer's/dementia clients.", timeline: "Within first 30 days", cost_est: 0, id: "dementia_cert" },
                    { name: "CPR/First Aid Certification", summary: "Emergency response training (2-year certification).", timeline: "Within first 60 days", cost_est: 63, id: "cpr_cert" }, 
                    { name: "Technology Platform Training for Caregivers", summary: "Training on using mobile app for clocking in/out and documentation.", timeline: "During orientation", cost_est: 0, id: "cg_tech_training" },
                    { name: "Shadow Experienced Caregiver on Initial Shifts", summary: "Accompany experienced caregiver on 2-4 client visits.", timeline: "First 1-2 weeks after orientation", cost_est: 0, id: "shadow_shifts" } 
                ]},
                { title: "Compliance & Regulatory: State & Local Compliance", items: [
                    { name: "Register as Home Care Provider with Maryland OHCQ", summary: "OHCQ oversees home care agencies; ensures compliance.", timeline: "60-90 days before planned opening", cost_est: 350, id: "register_ohcq" },
                    { name: "Complete Caregiver Background Check Registry", summary: "Caregivers must be registered and cleared before providing care.", timeline: "Before first client assignment", cost_est: 38, id: "cg_bg_registry" },
                    { name: "Comply with Maryland Wage and Hour Laws", summary: "Follow MD minimum wage ($15/hour as of 2025), overtime rules.", timeline: "Before hiring employees", cost_est: 0, id: "md_wage_hour" },
                    { name: "Verify Workers' Compensation Coverage", summary: "Proof required for various registrations.", timeline: "Before hiring first employee", cost_est: 0, id: "verify_workers_comp" },
                    { name: "Create Compliant Employee Handbook", summary: "Documents all employment policies (MD and federal compliant).", timeline: "Complete before hiring employees", cost_est: 1000, id: "create_handbook" }, 
                    { name: "Establish Wage and Hour Policies", summary: "Policies on pay rates, overtime calculation, meal breaks.", timeline: "Before hiring employees", cost_est: 0, id: "establish_wage_policies" },
                    { name: "Implement Anti-Discrimination and Harassment Policies", summary: "Written policies prohibiting discrimination and harassment.", timeline: "Before hiring employees", cost_est: 0, id: "implement_anti_discrim" },
                    { name: "Set Up OSHA-Compliant Safety Protocols", summary: "Safety programs including bloodborne pathogen training.", timeline: "Before employees start working", cost_est: 350, id: "setup_osha" },
                    { name: "Create Emergency Response Procedures", summary: "Written protocols for client emergencies (falls, medical crises).", timeline: "Before first client assignment", cost_est: 0, id: "create_emergency_proc" },
                    { name: "Establish Client Care Plans and Service Agreements", summary: "Standardized templates for client assessment and documentation.", timeline: "Before first client", cost_est: 0, id: "establish_care_plans" },
                    { name: "Set Up Caregiver Personnel Files", summary: "Secure filing system for all caregiver documentation.", timeline: "During onboarding", cost_est: 0, id: "setup_personnel_files" }
                ]}
            ]}
        ];

        // --- HELPER FUNCTIONS ---

        /**
         * Formats a number to a USD currency string.
         * @param {number} amount
         * @returns {string}
         */
        const formatCurrency = (amount) => {
            if (isNaN(amount)) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        };
        
        /**
         * Shows/Hides the custom modal.
         */
        window.closeModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        };

        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        };
        
        /**
         * Debounced function to save the item status to Firestore.
         */
        let saveDebounceTimer;
        const debounceSave = (itemId, actualCost, isComplete) => {
            clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(() => {
                if (db) { // Only attempt to save if Firebase is initialized
                    saveItemStatus(itemId, actualCost, isComplete);
                } else {
                    console.warn("Firestore is not initialized. Data not saved.");
                }
            }, 500); // 500ms delay
        };

        // --- FIREBASE AUTHENTICATION (Conditional) ---

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    console.log("Authentication successful. User ID:", userId);
                    await subscribeToChecklistStatus();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            const anonUser = await signInAnonymously(auth);
                            userId = anonUser.user.uid;
                            userIdDisplay.textContent = `User ID: ${userId} (Anonymous)`;
                            await subscribeToChecklistStatus();
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                        showModal("Auth Error", `Failed to sign in. ${error.message}`);
                        loadingSpinner.classList.add('hidden');
                    }
                }
            });
        } else {
            // Fallback if Firebase config is missing
            userId = 'OFFLINE_MODE';
            userIdDisplay.textContent = `User ID: ${userId} (Offline)`;
            checklistContainer.classList.remove('hidden');
            summaryContainer.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            renderChecklist();
            updateSummary();
            showModal("Offline Mode", "Firebase configuration is missing. Changes will NOT be saved.");
        }


        // --- FIREBASE DATA OPERATIONS ---

        const getStatusCollectionRef = () => {
            if (!userId || !db) {
                throw new Error("Database or User not ready.");
            }
            // Private user data path: /artifacts/{appId}/users/{userId}/checklist_status
            return collection(db, 'artifacts', appId, 'users', userId, 'checklist_status');
        };

        const subscribeToChecklistStatus = async () => {
            if (!db) return; // Should not happen if this function is called, but safety check
            try {
                const q = query(getStatusCollectionRef());
                
                onSnapshot(q, (querySnapshot) => {
                    const newChecklistState = {};
                    querySnapshot.forEach((doc) => {
                        newChecklistState[doc.id] = doc.data();
                    });
                    
                    checklistState = newChecklistState;
                    console.log("Checklist status loaded:", checklistState);
                    renderChecklist();
                    updateSummary();
                    
                    loadingSpinner.classList.add('hidden');
                    checklistContainer.classList.remove('hidden');
                    summaryContainer.classList.remove('hidden');

                }, (error) => {
                    console.error("Error subscribing to status:", error);
                    showModal("Data Error", `Could not load saved data. ${error.message}`);
                    loadingSpinner.classList.add('hidden');
                });

            } catch (error) {
                console.error("Subscription setup error:", error);
                loadingSpinner.classList.add('hidden');
                // Render with default state if subscription fails
                renderChecklist();
                updateSummary();
            }
        };

        const saveItemStatus = async (itemId, actualCost, isComplete) => {
            if (!userId || !db) {
                showModal("Error", "Data cannot be saved (Offline Mode or Auth Error).");
                return;
            }
            try {
                await setDoc(doc(getStatusCollectionRef(), itemId), {
                    actualCost: actualCost,
                    isComplete: isComplete,
                    lastUpdated: new Date().toISOString()
                });
                // The UI update is handled automatically by the onSnapshot listener
            } catch (error) {
                console.error("Error saving status:", error);
                showModal("Save Error", `Failed to save progress for ${itemId}. ${error.message}`);
            }
        };

        // --- UI RENDERING & LOGIC ---
        
        /**
         * Calculates and updates the financial and progress summary.
         */
        const updateSummary = () => {
            let totalItems = 0;
            let completedItems = 0;
            let totalEstCost = 0;
            let totalActualCost = 0;

            initialChecklistData.forEach(phase => {
                phase.sections.forEach(section => {
                    section.items.forEach(item => {
                        totalItems++;
                        totalEstCost += item.cost_est || 0;

                        const status = checklistState[item.id] || { isComplete: false, actualCost: 0 };
                        
                        if (status.isComplete) {
                            completedItems++;
                        }
                        const cost = parseFloat(status.actualCost) || 0;
                        totalActualCost += cost;
                    });
                });
            });

            const progress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
            const variance = totalEstCost - totalActualCost;
            
            // Update UI elements
            completedCountEl.textContent = completedItems;
            totalCountEl.textContent = totalItems;
            progressPercentEl.textContent = `${Math.round(progress)}%`;
            progressBarEl.style.width = `${progress}%`;
            
            estCostDisplay.textContent = formatCurrency(totalEstCost);
            actualCostDisplay.textContent = formatCurrency(totalActualCost);
            
            // Variance Styling
            varianceDisplay.textContent = formatCurrency(Math.abs(variance));
            varianceCardEl.classList.remove('border-t-green-600', 'border-t-red-600', 'border-t-yellow-600');
            varianceDisplay.classList.remove('text-green-700', 'text-red-700', 'text-gray-900');

            if (variance > 0) {
                varianceCardEl.classList.add('border-t-green-600'); // Under budget (Good)
                varianceDisplay.classList.add('text-green-700');
                varianceStatusEl.textContent = "Under Budget";
            } else if (variance < 0) {
                varianceCardEl.classList.add('border-t-red-600'); // Over budget (Bad)
                varianceDisplay.classList.add('text-red-700');
                varianceStatusEl.textContent = "Over Budget";
            } else {
                varianceCardEl.classList.add('border-t-gray-400'); // Exactly on budget or zero
                varianceDisplay.classList.add('text-gray-900');
                varianceStatusEl.textContent = "On Budget";
            }
        };


        /**
         * Renders the entire checklist structure.
         */
        const renderChecklist = () => {
            checklistContainer.innerHTML = '';
            
            initialChecklistData.forEach((phase, phaseIndex) => {
                const phaseEl = document.createElement('div');
                phaseEl.className = 'mb-12';
                
                // Phase Title - Elevated
                phaseEl.innerHTML = `
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-6 pb-2 border-b-4 border-indigo-400/50">
                        ${phase.phase}
                    </h2>
                `;

                phase.sections.forEach((section, sectionIndex) => {
                    const sectionId = `section-${phaseIndex}-${sectionIndex}`;
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'bg-white rounded-xl shadow-lg mb-6 overflow-hidden border border-gray-100';

                    // Section Header (Collapsible)
                    sectionEl.innerHTML += `
                        <button class="w-full text-left p-5 flex justify-between items-center text-xl font-bold text-gray-800 bg-gray-50 hover:bg-gray-100 transition duration-150 border-b border-gray-200" 
                            onclick="toggleCollapse('${sectionId}', this)">
                            ${section.title}
                            <i data-lucide="chevron-right" class="w-6 h-6 text-indigo-500 transition-transform duration-300 section-icon"></i>
                        </button>
                        <div id="${sectionId}" class="collapse-content">
                            <ul class="divide-y divide-gray-100">
                                ${section.items.map(item => renderChecklistItem(item)).join('')}
                            </ul>
                        </div>
                    `;
                    phaseEl.appendChild(sectionEl);
                });

                checklistContainer.appendChild(phaseEl);
            });
            
            // Once HTML is in place, replace data-lucide attributes with SVG icons
            lucide.createIcons();
        };

        /**
         * Renders a single checklist item row.
         * @param {Object} item 
         * @returns {string} HTML string
         */
        const renderChecklistItem = (item) => {
            const status = checklistState[item.id] || { isComplete: false, actualCost: 0 };
            const isChecked = status.isComplete;
            const actualCostValue = parseFloat(status.actualCost) || 0;
            
            return `
                <li class="p-4 grid grid-cols-1 md:grid-cols-10 gap-4 items-center transition duration-200 ${isChecked ? 'bg-green-50/70' : 'hover:bg-gray-50'}">
                    
                    <!-- Checkbox & Name (Cols 1-4) -->
                    <div class="md:col-span-3 flex items-start space-x-3">
                        <input type="checkbox" id="check-${item.id}" 
                            class="h-5 w-5 text-indigo-600 border-gray-300 rounded-lg focus:ring-indigo-500 mt-0.5"
                            ${isChecked ? 'checked' : ''}
                            onchange="handleCheckboxChange('${item.id}', this.checked)">
                        <label for="check-${item.id}" class="text-base font-semibold text-gray-800 cursor-pointer ${isChecked ? 'line-through text-gray-500' : ''}">
                            ${item.name}
                        </label>
                    </div>

                    <!-- Summary (Cols 5-5) -->
                    <div class="md:col-span-3 text-sm text-gray-600">
                        ${item.summary}
                    </div>
                    
                    <!-- Timeline (Cols 6-7) -->
                    <div class="md:col-span-2 text-sm text-gray-500 flex items-center">
                        <i data-lucide="calendar-check" class="w-4 h-4 inline mr-2 text-indigo-400"></i>
                        ${item.timeline || 'N/A'}
                    </div>

                    <!-- Est. Cost (Cols 8) -->
                    <div class="md:col-span-1 text-sm font-medium text-gray-700 text-right">
                        ${formatCurrency(item.cost_est)}
                    </div>
                    
                    <!-- Actual Cost Input (Cols 9-10) -->
                    <div class="md:col-span-1 flex justify-end">
                        <div class="relative w-full max-w-[120px]">
                             <span class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">$</span>
                            <input type="number" id="cost-${item.id}" 
                                min="0" step="0.01" placeholder="0.00"
                                value="${actualCostValue === 0 ? '' : actualCostValue.toFixed(2)}"
                                class="cost-input w-full pl-6 pr-2 py-2 border border-gray-300 rounded-lg text-sm text-right focus:ring-indigo-500 focus:border-indigo-500"
                                oninput="handleCostChange('${item.id}', this.value, document.getElementById('check-${item.id}').checked)">
                        </div>
                    </div>
                </li>
            `;
        };

        // --- EVENT HANDLERS ---
        
        window.toggleCollapse = (contentId, button) => {
            const content = document.getElementById(contentId);
            const icon = button.querySelector('.section-icon');

            // Toggle visibility
            const isOpen = content.classList.contains('collapse-open');
            if (isOpen) {
                content.classList.remove('collapse-open');
                icon.classList.remove('rotated-icon');
            } else {
                content.classList.add('collapse-open');
                icon.classList.add('rotated-icon');
            }
        };

        window.handleCheckboxChange = (itemId, isChecked) => {
            const costInput = document.getElementById(`cost-${itemId}`);
            // If checking the box, and cost is zero, default to the estimated cost
            let actualCost = parseFloat(costInput.value) || 0;
            
            if (isChecked && actualCost === 0) {
                 const itemData = initialChecklistData.flatMap(p => p.sections).flatMap(s => s.items).find(i => i.id === itemId);
                 actualCost = itemData ? itemData.cost_est : 0;
                 costInput.value = actualCost.toFixed(2);
            }
            
            debounceSave(itemId, actualCost, isChecked);
        };
        
        window.handleCostChange = (itemId, value, isChecked) => {
            const actualCost = parseFloat(value) || 0;
            // If a cost is entered, assume the item is complete unless manually unchecked
            const checkbox = document.getElementById(`check-${itemId}`);
            let newIsChecked = isChecked;

            if (actualCost > 0 && !isChecked) {
                newIsChecked = true;
                checkbox.checked = true;
            } else if (actualCost === 0 && isChecked) {
                 // Do nothing, allow user to keep it checked even with 0 cost
            }

            debounceSave(itemId, actualCost, newIsChecked);
        };

        // Initialize all collapse sections to be closed on load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.collapse-content').forEach(el => {
                el.classList.remove('collapse-open');
            });
        });

    </script>
</body>
</html>
